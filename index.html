<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>گالری محصولات (IndexedDB)</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn&display=swap');
    body { font-family: 'Vazirmatn', sans-serif; margin: 0; background: #f9f9f9; color: #333; direction: rtl; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: #4CAF50; color: white; font-size: 20px; position: sticky; top: 0; z-index: 100; }
    .menu-icon { cursor: pointer; font-size: 28px; user-select: none; }
    .side-menu { position: fixed; left: -100%; top: 0; width: 280px; height: 100%; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.3); transition: left 0.3s ease; padding: 20px; z-index: 1001; overflow-y: auto; }
    .side-menu.active { left: 0; }
    .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); display: none; z-index: 1000; }
    .overlay.active { display: block; }
    .side-menu h3 { margin: 0 0 10px 0; font-size: 18px; color: #333; }
    .side-menu label { display: block; margin: 8px 0 4px; font-size: 14px; }
    .side-menu input, .side-menu textarea { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 5px; font-family: inherit; }
    .side-menu button { margin-top: 15px; width: 100%; padding: 10px; border: none; background: #4CAF50; color: #fff; border-radius: 5px; font-size: 15px; cursor: pointer; }
    .side-menu button:hover { opacity: 0.9; }
    .delete-all { background: #e53935; }
    .backup { background: #2196F3; }
    .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; padding: 20px; max-width: 1200px; margin: auto; }
    .product { background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.15); transition: transform 0.2s; display: flex; flex-direction: column; justify-content: space-between; }
    .product:hover { transform: translateY(-5px); }
    .product img { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; }
    .info { padding: 10px; text-align: center; flex-grow: 1; }
    .info h3 { margin: 5px 0; font-size: 16px; color: #222; }
    .info p { margin: 5px 0; font-size: 14px; color: #666; }
    .price { font-weight: bold; color: #4CAF50; margin-top: 8px; }
    .actions { display: flex; justify-content: space-around; padding: 10px; border-top: 1px solid #eee; background: #fafafa; }
    .actions button { flex: 1; margin: 0 5px; padding: 6px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
    .actions .edit { background: #FFC107; color: #fff; }
    .actions .delete { background: #F44336; color: #fff; }
    .preview { margin-top: 10px; text-align: center; }
    .preview img { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <header>
    <div>📦 گالری محصولات (IndexedDB)</div>
    <div class="menu-icon" onclick="toggleMenu()">☰</div>
  </header>
  <div class="overlay" id="overlay" onclick="toggleMenu(true)"></div>
  <div class="side-menu" id="sideMenu">
    <h3 id="formTitle">➕ افزودن محصول جدید</h3>
    <label>نام محصول:</label>
    <input id="productName" type="text">
    <label>توضیحات:</label>
    <textarea id="productDesc" rows="2"></textarea>
    <label>قیمت:</label>
    <input id="productPrice" type="text">
    <label>تعداد در بسته:</label>
    <input id="productCount" type="text">
    <label>انتخاب عکس:</label>
    <input id="productImage" type="file" accept="image/*" onchange="previewImage(event)">
    <div class="preview" id="imagePreview"></div>
    <button id="saveButton" onclick="addProduct()">افزودن به گالری</button>
    <button class="delete-all" onclick="deleteAllProducts()">🗑️ پاک کردن کلیه محصولات</button>
    <button class="backup" onclick="exportData()">📤 گرفتن بک‌آپ</button>
    <button class="backup" onclick="importData()">📥 بارگذاری بک‌آپ</button>
    <input type="file" id="importFile" accept="application/json" style="display:none" onchange="handleImport(event)">
  </div>
  <div class="gallery" id="gallery"></div>
  <script>
    // --- IndexedDB Functions ---
    let db;
    const DB_NAME = "ProductGalleryDB";
    const STORE_NAME = "products";
    let uploadedImageData = null;
    let editingId = null;
    const MASTER_PASSWORD = "3818542";

    // Open/Upgrade IndexedDB
    function openDB(callback) {
      const request = window.indexedDB.open(DB_NAME, 1);
      request.onupgradeneeded = function(e) {
        db = e.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) {
          db.createObjectStore(STORE_NAME, { keyPath: "id", autoIncrement: true });
        }
      };
      request.onsuccess = function(e) {
        db = e.target.result;
        if (callback) callback();
      };
      request.onerror = function() { alert("خطا در دسترسی به دیتابیس!"); };
    }

    // Add Product
    function addProduct() {
      const name = document.getElementById("productName").value.trim();
      const desc = document.getElementById("productDesc").value.trim();
      const price = document.getElementById("productPrice").value.trim();
      const count = document.getElementById("productCount").value.trim();
      const image = uploadedImageData || "";
      if (!name || !price) { alert("نام و قیمت محصول الزامی است ❗"); return; }
      openDB(() => {
        const tx = db.transaction(STORE_NAME, "readwrite");
        const store = tx.objectStore(STORE_NAME);
        if (editingId !== null) {
          store.get(editingId).onsuccess = function(e) {
            const data = e.target.result;
            data.name = name;
            data.desc = desc;
            data.price = price;
            data.count = count;
            data.image = image || data.image;
            store.put(data);
            editingId = null;
            document.getElementById("saveButton").innerText = "افزودن به گالری";
            document.getElementById("formTitle").innerText = "➕ افزودن محصول جدید";
            tx.oncomplete = function() { renderProducts(); clearForm(); toggleMenu(true); };
          };
        } else {
          store.add({ name, desc, price, count, image });
          tx.oncomplete = function() { renderProducts(); clearForm(); toggleMenu(true); };
        }
      });
    }

    // Render Products
    function renderProducts() {
      gallery.innerHTML = "";
      openDB(() => {
        const tx = db.transaction(STORE_NAME, "readonly");
        const store = tx.objectStore(STORE_NAME);
        const req = store.openCursor();
        req.onsuccess = function(e) {
          const cursor = e.target.result;
          if (cursor) {
            const p = cursor.value;
            const product = document.createElement("div");
            product.classList.add("product");
            product.innerHTML = `
              <img src="${p.image || "https://via.placeholder.com/400"}" alt="${p.name}">
              <div class="info">
                <h3>${p.name}</h3>
                <p>${p.desc || "بدون توضیحات"}</p>
                <div class="price">قیمت: ${p.price} تومان</div>
                <p>تعداد در بسته: ${p.count || "-"}</p>
              </div>
              <div class="actions">
                <button class="edit" onclick="editProduct(${p.id})">ویرایش</button>
                <button class="delete" onclick="deleteProduct(${p.id})">حذف</button>
              </div>`;
            gallery.appendChild(product);
            cursor.continue();
          }
        };
      });
    }

    // Edit Product
    function editProduct(id) {
      openDB(() => {
        const tx = db.transaction(STORE_NAME, "readonly");
        const store = tx.objectStore(STORE_NAME);
        store.get(id).onsuccess = function(e) {
          const p = e.target.result;
          document.getElementById("productName").value = p.name;
          document.getElementById("productDesc").value = p.desc;
          document.getElementById("productPrice").value = p.price;
          document.getElementById("productCount").value = p.count;
          uploadedImageData = p.image;
          if (p.image) { document.getElementById("imagePreview").innerHTML = `<img src="${p.image}" alt="preview">`; }
          editingId = id;
          document.getElementById("saveButton").innerText = "ذخیره تغییرات";
          document.getElementById("formTitle").innerText = "✏️ ویرایش محصول";
          sideMenu.classList.add("active"); overlay.classList.add("active");
        };
      });
    }

    // Delete Product
    function deleteProduct(id) {
      if (!confirm("حذف این محصول؟")) return;
      openDB(() => {
        const tx = db.transaction(STORE_NAME, "readwrite");
        const store = tx.objectStore(STORE_NAME);
        store.delete(id);
        tx.oncomplete = function() { renderProducts(); };
      });
    }

    // Delete All Products
    function deleteAllProducts() {
      const pass = prompt("برای پاک کردن تمام محصولات، رمز را وارد کنید:");
      if (pass === null) return;
      if (pass === MASTER_PASSWORD) {
        openDB(() => {
          const tx = db.transaction(STORE_NAME, "readwrite");
          const store = tx.objectStore(STORE_NAME);
          store.clear();
          tx.oncomplete = function() { renderProducts(); alert("✅ همه محصولات پاک شدند"); };
        });
      } else { alert("❌ رمز اشتباه است!"); }
    }

    // Export Data (Backup)
    function exportData() {
      openDB(() => {
        const tx = db.transaction(STORE_NAME, "readonly");
        const store = tx.objectStore(STORE_NAME);
        const products = [];
        store.openCursor().onsuccess = function(e) {
          const cursor = e.target.result;
          if (cursor) {
            products.push(cursor.value);
            cursor.continue();
          } else {
            const blob = new Blob([JSON.stringify(products)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url; a.download = "products_backup.json"; a.click();
          }
        };
      });
    }

    // Import Data (Restore Backup)
    function importData() { document.getElementById("importFile").click(); }
    function handleImport(event) {
      const file = event.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const products = JSON.parse(e.target.result);
          openDB(() => {
            const tx = db.transaction(STORE_NAME, "readwrite");
            const store = tx.objectStore(STORE_NAME);
            store.clear();
            products.forEach(product => { store.add(product); });
            tx.oncomplete = function() { renderProducts(); alert("✅ بک‌آپ با موفقیت بازگردانی شد"); };
          });
        } catch { alert("❌ فایل بک‌آپ معتبر نیست!"); }
      };
      reader.readAsText(file);
    }

    // Preview Image
    function previewImage(event) {
      const file = event.target.files[0];
      if (!file) return;
      resizeImage(file, 800, 800, (resizedData) => {
        uploadedImageData = resizedData;
        document.getElementById("imagePreview").innerHTML = `<img src="${uploadedImageData}" alt="preview">`;
      });
    }

    // Resize Image
    function resizeImage(file, maxWidth = 800, maxHeight = 800, callback) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          let width = img.width;
          let height = img.height;
          if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
          if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; }
          const canvas = document.createElement("canvas");
          canvas.width = width; canvas.height = height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, width, height);
          const dataUrl = canvas.toDataURL("image/jpeg", 0.7);
          callback(dataUrl);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    // Clear Form
    function clearForm() {
      document.getElementById("productName").value = "";
      document.getElementById("productDesc").value = "";
      document.getElementById("productPrice").value = "";
      document.getElementById("productCount").value = "";
      document.getElementById("productImage").value = "";
      document.getElementById("imagePreview").innerHTML = "";
      uploadedImageData = null;
    }

    // Menu
    const sideMenu = document.getElementById("sideMenu");
    const overlay = document.getElementById("overlay");
    function toggleMenu(forceClose = false) {
      if (forceClose) {
        sideMenu.classList.remove("active");
        overlay.classList.remove("active");
      } else {
        sideMenu.classList.toggle("active");
        overlay.classList.toggle("active");
      }
    }

    // Onload
    window.onload = function() {
      openDB(renderProducts);
    };

    // PWA Service Worker
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js")
        .then(() => console.log("✅ Service Worker Registered"))
        .catch(err => console.error("SW fail:", err));
    }
  </script>
</body>
</html>
